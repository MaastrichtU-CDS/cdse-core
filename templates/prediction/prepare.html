{% extends "admin/base.html" %}

{% block content %}

<div class="wizard-main">
    <h1>Prediction Model Prepare</h1>

    <form action="{% url 'prediction_prepare' %}" method="post">

        {% csrf_token %}
        <input type="hidden" id="fhir_endpoint" name="fhir_endpoint" value="{{fhir_endpoint|default_if_none:''}}">
        <input type="hidden" id="patient_id" name="patient_id" value="{{patient_id|default_if_none:''}}">
        <input type="hidden" id="selected_model_uri" name="selected_model_uri"
               value="{{selected_model_uri|default_if_none:''}}">

        <div class="selected-patient-box">
            <div class="padding">
                <h2>Selected patient</h2>
                <p>Name: {{patient_information.name}}</p>
                <p>Birthdate: {{patient_information.birthdate}}</p>
            </div>
        </div>

        <table class="parameter-table">
            <thead>
            <tr>
                <th>Model input</th>
                <th>Found values</th>
                <th>Manual override</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for input_item in model_input_list %}
            <tr>
                <td>{% if input_item.description_parent is not None %}{{input_item.description_parent}}{% else %}{{input_item.fhir_code_parent}}{% endif %}</td>
                <td>{% if input_item.matching_child_parameter is not None %}{% if input_item.matching_child_parameter.description_child is not None %}{{input_item.matching_child_parameter.description_child}}{% else %}{{input_item.matching_child_parameter.fhir_code_child}}{% endif %}{% endif %}</td>
                <td>
                    <select name="{{input_item.fhir_code_parent}}-override" id="{{input_item.fhir_code_parent}}-override">
                        <option value="">---------</option>
                        {% for child in input_item.child_values %}
                        <option value="{{ child.fhir_code_child }}">{% if child.description_child is not None %}{{child.description_child}}{% else %}{{child.fhir_code_child}}{% endif %}</option>
                        {% endfor %}
                    </select>
                </td>
                <td id="reset-{{input_item.fhir_code_parent}}" class="text-underline cursor-pointer">Reset</td>
            </tr>

            <input type="hidden" id="{{input_item.fhir_code_parent}}" name="{{input_item.fhir_code_parent}}"
                   value="{{input_item.matching_child_parameter.fhir_code_child|default_if_none:''}}">
            {% endfor %}
            </tbody>
        </table>

        <button type="submit" name='action' value="start_prediction" class="next-button">Start</button>
    </form>
    <br>
    <a href="/prediction/start" class="next-button">Back</a>
</div>

<script type="text/javascript">
{% for input_item in model_input_list %}
document.getElementById('reset-{{input_item.fhir_code_parent}}').onclick=function(){
    var {{input_item.fhir_code_parent}} = document.querySelectorAll('#{{input_item.fhir_code_parent}}-override option');
for (var i = 0, l = {{input_item.fhir_code_parent}}.length; i < l; i++) {
    {{input_item.fhir_code_parent}}[i].selected = {{input_item.fhir_code_parent}}[i].defaultSelected;
}}
{% endfor %}

</script>
{% endblock content %}
